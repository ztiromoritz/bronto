<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Bronto</title>
    <link rel="shortcut icon" type="image/x-icon" href="assets/favicon.png">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="js/phaser/phaser.js"></script>
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/jquery-mobile-bower/js/jquery.mobile-1.4.5.js"></script>
    <script src="bower_components/lodash/lodash.js"></script>
    <script src="bower_components/handlebars/handlebars.js"></script>

    <script src="js/bronto.player.js"></script>
    <script src="js/bronto.util.js"></script>


    <meta name="apple-mobile-web-app-title" content="Bronto"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="apple-mobile-web-app-capable" content="no"/>
    <link href="assets/favicon.png" sizes="16x16" rel="apple-touch-icon"/>
    <!--
    <link href="path/to/icon-152x152.png" sizes="152x152" rel="apple-touch-icon" />
    <link href="path/to/icon-144x144.png" sizes="144x144" rel="apple-touch-icon" />
    <link href="path/to/icon-120x120.png" sizes="120x120" rel="apple-touch-icon" />
    <link href="path/to/icon-114x114.png" sizes="114x114" rel="apple-touch-icon" />
    <link href="path/to/icon-76x76.png"   sizes="76x76"   rel="apple-touch-icon" />
    <link href="path/to/icon-72x72.png"   sizes="72x72"   rel="apple-touch-icon" />
    <link href="path/to/icon-60x60.png"   sizes="60x60"   rel="apple-touch-icon" />
    <link href="path/to/icon-57x57.png"   sizes="57x57"   rel="apple-touch-icon" />
    -->
    <meta name="viewport" content="minimal-ui">

    <script>

        // Use $$(function(){ ....}) instead of jqueries $(function(){...}) to run code after loading all assets
        // $$ is a holder for all global stuff.
        var $$ = function(callback){
            $$.preloadCallbacks.push(callback);
        }; //the game
        $$.preloadCallbacks = [];
        $$.init = function (){
            for(var i = 0; i<$$.preloadCallbacks.length; i++){
                if(_.isFunction($$.preloadCallbacks[i]))
                    $$.preloadCallbacks[i]($$);
            }
        };
        //=============

        var character = {
            img: 'assets/amber.png',
            name: 'Busarakam',
            level: 2,
            xp: 220,
            health: 56,
            current_health: 56,
            attack: 8,
            strength: 20,
            speed: 16,
            jump: 22
        };

        var opponent = {
            img: 'assets/chuck.png',
            name: 'Olaf',
            level: 2,
            xp: 220,
            health: 10,
            current_health: 10,
            attack: 4,
            strength: 20,
            speed: 16,
            jump: 22
        };


        $(function () {

            var tileLayer;

            function characterTest(){
                var characterSheet = Handlebars.compile($$.game.cache.getText("character-template"));

                $('#characters').html(characterSheet(character));
            }

            function preload(){
                //Also used to load handlebar templates
                this.load.text('character-template','./tpl/character.html');
                this.load.text('fight-template','./tpl/fight.html');
                this.load.audio('served', 'assets/sounds/cardServed.wav');
                this.load.audio('point', 'assets/sounds/point.wav');
                this.load.audio('hit', 'assets/sounds/hit.wav');

                this.load.spritesheet('dino', 'assets/kinds/kind-02-00.png', 32, 32);

                this.load.spritesheet('background_tileset', 'assets/pyxel/background_tileset.png', 16, 16);
                this.load.tilemap('level1', 'assets/tiled/level1.json', null, Phaser.Tilemap.TILED_JSON);
                this.stage.smoothed = false;
            }

            function create(){
                this.stage.smoothed = false;
                $$.init();
                //TODO: sound class
                $$.sounds = {}
                $$.sounds.served = this.add.audio('served');
                $$.sounds.served.allowMultiple = true;
                $$.sounds.point = this.add.audio('point');
                $$.sounds.point.allowMultiple = true;
                $$.sounds.hit = this.add.audio('hit');
                $$.sounds.hit.allowMultiple = true;
                this.sound.mute = true;

                //characterTest();
               // $$.fight.init(character, opponent);
                this.physics.startSystem(Phaser.Physics.ARCADE);

                var map = this.add.tilemap('level1');
                map.addTilesetImage('background_tileset', 'background_tileset');
                tileLayer = map.createLayer('Ground');
                tileLayer.resizeWorld();
                map.setCollision(getGIDs('solid', map, "solid"), true, tileLayer);
                console.log(getGIDs('solid', map, "solid"));

                player = new Player($$.game,30, 10);
                this.add.existing(player);
                this.camera.follow(player);

            }

            function update(){
                this.physics.arcade.collide(player, tileLayer);
            }

            $$.game = new Phaser.Game(480, 320,
                    Phaser.AUTO,
                    'game',
                    {preload: preload, create: create, update: update},
                    true, //transparent
                    true   //antialias
            );

        });

    </script>
    <script src="js/fight.js"></script>


</head>
<body>
<div style="width: 480px; margin: 20px auto; text-align: center;">

    <div class="title">

    <h1>Bronto</h1>

    <h3>A dinosaur runner rpg</h3>

    </div>



    <div id="wrapper">

        <div id="background2" class="screen">

        </div>

        <div id="background" class="screen">
            <img src="assets/out.gif" class="stretch" alt="" />
        </div>

        <div id="fight_screen" class="screen">

        </div>

        <div id="game" class="screen">

        </div>

    </div>

    <div class="button"><img src="assets/egg.png" alt="Pixel Egg"/>Generate Character</div>
    <div id="characters"></div>
</div>
</body>

</html>
